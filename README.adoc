= 2019 Kringlecon ctf writeup
Brandon Ingalls <brandon@tr4.dev>
v0.1.0, 2019-12-28
:toc:
:imagesdir: ./images

== Challenges

=== __ - Start of Kringlecon

Location: `Train Station`

Difficulty: `0/5`

image::99/00-Hello.png[My character next to santa]

* After signing in for the first time you find yourself at the `Train Station`
* Talk to `Santa`
* Get story
+
----
(Santa)
- Welcome to the North Pole and KringleCon 2!
- Last year, KringleCon hosted over 17,500 attendees and my castle got a little crowded.
- We moved the event to Elf University (Elf U for short), the North Pole’s largest venue.
- Please feel free to explore, watch talks, and enjoy the con!
----

=== 00 - Talk to Santa in the Quad

Location: `The Quad`

Difficulty: `0/5`

image::main/00/00-location.png[Me next to Santa]

.Objective
----
Enter the campus quad and talk to Santa.
----

==== Solution

. Click on `Santa` until they repeat

==== Chat

.Chat log
----
(Santa)
- This is a little embarrassing, but I need your help.
- Our KringleCon turtle dove mascots are missing!
- They probably just wandered off.
- Can you please help find them?
- To help you search for them and get acquainted with KringleCon, I’ve created some objectives for you. You can see them in your badge.
- Where's your badge? Oh! It's that big, circle emblem on your chest - give it a tap!
- We made them in two flavors - one for our new guests, and one for those who've attended both KringleCons.
- After you find the Turtle Doves and complete objectives 2-5, please come back and let me know.
- Not sure where to start? Try hopping around campus and talking to some elves.
- If you help my elves with some quicker problems, they'll probably remember clues for the objectives.
----

=== 01 - Find the Turtle Doves

Location: `Student Union`

Difficulty: `0/5`

image::main/01/00-location.png[Me next to the doves]

.Objective
----
Find the missing turtle doves.
----

==== Solution

. Click on the doves until they repeat

==== Chat

.Chat log
----
(Michael and Jane - Two Turtle Doves)
- Hoot Hooot?
----

=== 02 - Unredact Threatening Document

Location: `The Quad`

Difficulty: `1/5`

image::main/02/00-location.png[Me next to the redacted document]

.Objective
----
Someone sent a threatening letter to Elf University. What is the first word in ALL CAPS in the subject line of the letter? Please find the letter in the Quad.
----

==== Links

. link:files/main/02/LetterToElfUPersonnel.pdf[LetterToElfUPersonnel.pdf]
** The redacted document
+
NOTE: SHA256 `2f7b3ba81f1718d29ee73e82b19eb0f7a85e5b7835aaac0155edd233619b3c5e`

==== Solution

. Open the PDF
+
image::main/02/01-document.png[Picture of redacted document]
+
. Select all text in the document
+
NOTE: Using `[Ctrl]` + `a`
+
image::main/02/02-selected.png[Picture of highlighted document]
+
. Copy the text
+
NOTE: Using `[Ctrl]` + `c`
+
. Paste the copied content into a text editor
+
NOTE: Using `[Ctrl]` + `v`
+
.Documents unredacted contents
----
Date: February 28, 2019

To the Administration, Faculty, and Staff of Elf University
17 Christmas Tree Lane
North Pole

From: A Concerned and Aggrieved Character

Subject: DEMAND: Spread Holiday Cheer to Other Holidays and Mythical Characters… OR
ELSE!


Attention All Elf University Personnel,

It remains a constant source of frustration that Elf University and the entire operation at the
North Pole focuses exclusively on Mr. S. Claus and his year-end holiday spree. We URGE
you to consider lending your considerable resources and expertise in providing merriment,
cheer, toys, candy, and much more to other holidays year-round, as well as to other mythical
characters.

For centuries, we have expressed our frustration at your lack of willingness to spread your
cheer beyond the inaptly-called “Holiday Season.” There are many other perfectly fine
holidays and mythical characters that need your direct support year-round.

If you do not accede to our demands, we will be forced to take matters into our own hands.
We do not make this threat lightly. You have less than six months to act demonstrably.

Sincerely,

--A Concerned and Aggrieved Character

Confidential
Confidential
----

`First word in ALL CAPS` = `DEMAND`

=== 03 - Windows Log Analysis: Evaluate Attack Outcome

Location: `Offline`

Difficulty: `1/5`

.Objective
----
We're seeing attacks against the Elf U domain! Using the event log data, identify the user account that the attacker compromised using a password spray attack. Bushy Evergreen is hanging out in the train station and may be able to help you out.
----

==== Links

. link:files/main/03/Security.evtx.zip[Security.evtx.zip]
** Archive containing a Windows event log export for `Security`
+
NOTE: SHA256 `7583da028561af31a25a9cecab2c0bb77967a646e4808773b0cc23e62b70c0dd`

==== Solution

. Setup working directory for this challenge
+
[source, bash, options="nowrap"]
----
# Create a temp directory
[~]$ cd "$(mktemp -d /tmp/ctf-03.XXX)"

# Extract the provided archive
[/tmp/ctf-03.rhb]$ unzip /path/to/Security.evtx.zip
Archive:  /path/to/Security.evtx.zip
  inflating: Security.evtx

# Create a python2 virtualenv
[/tmp/ctf-03.rhb]$ python2 -m virtualenv .venv

# Verify layout
[/tmp/ctf-03.rhb]$ ls -A1
Security.evtx
.venv
----
+
. Activate the python virtualenv
+
[source, bash, options="nowrap"]
----
[/tmp/ctf-03.rhb]$ source .venv/bin/activate
(.venv) [/tmp/ctf-03.rhb]$
----
+
. Install python tools
+
----
# Install tools via pip
(.venv) [/tmp/ctf-03.rhb]$ pip install \
                                       'python-evtx>=0.6.1' \
                                       'yq>=2.10.0'
----
+
. Convert `.evtx` to `.xml`
+
[source, bash, options="nowrap"]
----
# Convert evtx => xml
(.venv) [/tmp/ctf-03.rhb]$ time evtx_dump.py Security.evtx > Security.xml
evtx_dump.py Security.evtx > Security.xml  39.01s user 0.07s system 99% cpu 39.084 total

# Check sizes
(.venv) [/tmp/ctf-03.rhb]$ ls -Alh Security.evtx Security.xml
-rwxr-xr-x 1 t4r t4r 3.1M Nov 19 06:29 Security.evtx
-rw-r--r-- 1 t4r t4r 6.9M Dec 28 14:40 Security.xml
----
+
. Convert `.xml` to `.json`
+
[source, bash, options="nowrap"]
----
(.venv) [/tmp/ctf-03.rhb]$ time xq '.Events' Security.xml > Security.json
xq '.Events' Security.xml > Security.json  10.74s user 2.95s system 121% cpu 11.282 total
----
+
. Disable virtualenv
+
NOTE: We shouldn't need it anymore
+
[source, bash, options="nowrap"]
----
(.venv) [/tmp/ctf-03.rhb]$ deactivate
[/tmp/ctf-03.rhb]$
----
+
. Start pivoting with `jq`
.. Figure out when the attack started - Event ID 4625
+
[source, bash, options="nowrap"]
----
# Filter for failed logins
[/tmp/ctf-03.rhb]$ cat Security.json \
                     | jq '.Event[] | select(.System.EventID."#text"=="4625")' > Security-4625.json

# Store jq filter
[/tmp/ctf-03.rhb]$ read -r -d '' filter << 'EOF'
[
  {
    "time": .System.TimeCreated."@SystemTime",
    "user": .EventData.Data[] | select(."@Name"=="TargetUserName")."#text",
    "ip": .EventData.Data[] | select(."@Name"=="IpAddress")."#text"
  }
]
  | sort_by(.time)
    | .[]
EOF

# Parse into readable format
[/tmp/ctf-03.rhb]$ cat Security-4625.json \
                     | jq -c "${filter}" > failed_logins.jsonl
----
+
... Review `failed_logins.jsonl`
+
NOTE: Scan happened `2019-11-19 12:21` => `2019-11-19 12:22`
+
.. Event ID 4624 (An account was successfully logged on)
+
[source, bash, options="nowrap"]
----
# Filter for successful logins
[/tmp/ctf-03.rhb]$ cat Security.json \
                     | jq '.Event[] | select(.System.EventID."#text"=="4624")' > Security-4624.json
----
+
.Example 4624 event
image::main/03/00-4624.png[Example 4624 event]
+
.. Parse filtered `4624` events into a more readable format
+
[source, bash, options="nowrap"]
----
[/tmp/ctf-03.rhb]$ read -r -d '' filter << 'EOF'
[
  {
    "time": .System.TimeCreated."@SystemTime",
    "user": .EventData.Data[] | select(."@Name"=="TargetUserName")."#text",
    "ip": .EventData.Data[] | select(."@Name"=="IpAddress")."#text"
  }
]
  | sort_by(.time)
    | .[]
EOF

[/tmp/ctf-03.rhb]$ cat Security-4624.json \
                     | jq -c "${filter}" \
                       | tee logins.jsonl
{"time":"2019-08-24 00:00:20.189180","user":"pminstix","ip":"192.168.86.128"}
{"time":"2019-08-24 00:00:41.380116","user":"DC1$","ip":"fe80::75f6:7c88:9877:ce71"}
{"time":"2019-11-19 12:21:34.496546","user":"pminstix","ip":"192.168.86.128"}
{"time":"2019-11-19 12:21:41.375494","user":"DC1$","ip":"::1"}
{"time":"2019-11-19 12:21:45.755442","user":"supatree","ip":"127.0.0.1"}
{"time":"2019-11-19 12:21:46.715054","user":"DC1$","ip":"fe80::75f6:7c88:9877:ce71"}
{"time":"2019-11-19 12:21:46.724463","user":"DC1$","ip":"fe80::75f6:7c88:9877:ce71"}
{"time":"2019-11-19 12:22:25.172413","user":"DC1$","ip":"fe80::75f6:7c88:9877:ce71"}
{"time":"2019-11-19 12:22:25.175280","user":"DC1$","ip":"fe80::75f6:7c88:9877:ce71"}
{"time":"2019-11-19 12:22:25.180609","user":"DC1$","ip":"::1"}
{"time":"2019-11-19 12:22:25.184385","user":"DC1$","ip":"192.168.86.190"}
{"time":"2019-11-19 12:22:25.284060","user":"DC1$","ip":"fe80::75f6:7c88:9877:ce71"}
{"time":"2019-11-19 12:22:41.383135","user":"DC1$","ip":"::1"}
{"time":"2019-11-19 12:23:05.847099","user":"supatree","ip":"192.168.86.128"}
{"time":"2019-11-19 12:23:41.405107","user":"DC1$","ip":"::1"}
{"time":"2019-11-19 12:23:47.222954","user":"DC1$","ip":"fe80::75f6:7c88:9877:ce71"}
----
+
.. Filter out `Kerberos` events
+
[source, bash, options="nowrap"]
----
[/tmp/ctf-03.rhb]$ cat logins.jsonl | grep -vE 'DC1\$'
{"time":"2019-08-24 00:00:20.189180","user":"pminstix","ip":"192.168.86.128"}
{"time":"2019-11-19 12:21:34.496546","user":"pminstix","ip":"192.168.86.128"}
{"time":"2019-11-19 12:21:45.755442","user":"supatree","ip":"127.0.0.1"}
{"time":"2019-11-19 12:23:05.847099","user":"supatree","ip":"192.168.86.128"}
----
... Note the odd one out
+
----
{"time":"2019-11-19 12:21:45.755442","user":"supatree","ip":"127.0.0.1"}
----
+
NOTE: Answer: `supatree`

=== 04 - Windows Log Analysis: Determine Attacker Technique

Location: `Offline`

Difficulty: `2/5`

.Objective
----
Using these normalized Sysmon logs, identify the tool the attacker used to retrieve domain password hashes from the lsass.exe process. For hints on achieving this objective, please visit Hermey Hall and talk with SugarPlum Mary.
----

==== Links

* link:files/main/04/sysmon-data.json.zip[sysmon-data.json.zip]
** Archive containing Sysmon data formatted as json
+
NOTE: SHA256 `b54e4d573c100eb51328673f057e51b6292e2e071b421e94edf7d1fd02447d06`

==== Solution

. Create working directory
+
[source, bash, options="nowrap"]
----
# Create a temp directory
[~]$ cd "$(mktemp -d /tmp/ctf-04.XXX)"

# Unzip provided archive
[/tmp/ctf-04.9SY]$ unzip /path/to/sysmon-data.json.zip
Archive:  /path/to/sysmon-data.json.zip
  inflating: sysmon-data.json

# Verify size
[/tmp/ctf-04.9SY]$ ls -Alh sysmon-data.json
-rwx------ 1 t4r t4r 1.8M Dec  5 14:41 sysmon-data.json
----
+
. Figure out what type sysmon events we have
+
[source, bash, options="nowrap"]
----
[/tmp/ctf-04.9SY]$ cat sysmon-data.json | jq '[.[].event_type] | unique'
[
  "file",
  "network",
  "process",
  "registry"
]
----
+
NOTE: As the challenge is asking for what tool was run on the host I decided to start with `process` events (event_id: `1`)
+
. Filter out `event_type=process`
+
[source, bash, options="nowrap"]
----
# Filter process events into `sysmon-data-process.jsonl`
[/tmp/ctf-04.9SY]$ cat sysmon-data.json \
                     | jq -c '.[] | select(.event_type=="process")' > sysmon-data-process.jsonl

# Create an abbriged version of the process file
# - This is easier to skim through
[/tmp/ctf-04.9SY]$ cat sysmon-data-process.jsonl \
                     | jq -c '[{"timestamp", "user_name", "process_name", "command_line"}] | sort_by(.timestamp) | .[]' > process_short.jsonl

# Filter out boring commands with grep as you go
[/tmp/ctf-04.9SY]$ cat process_short.jsonl \
                     | grep -vE '(powershell|net|wevtutil|cmd)\.exe'
{"timestamp":132186398470300000,"user_name":"SYSTEM","process_name":"ntdsutil.exe","command_line":"ntdsutil.exe  \"ac i ntds\" ifm \"create full c:\\hive\" q q"}
----

NOTE: Answer: `ntdsutil`

[quote, 'https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc753343(v%3Dws.11)[Microsoft]']
Ntdsutil.exe is a command-line tool that provides management facilities for Active Directory Domain Services (AD DS) and Active Directory Lightweight Directory Services (AD LDS). You can use the ntdsutil commands to perform database maintenance of AD DS, manage and control single master operations, and remove metadata left behind by domain controllers that were removed from the network without being properly uninstalled. This tool is intended for use by experienced administrators.

== Side challenges

=== Escaping ED

Location: `Train Station`

image::side/00-escape-ed/00-location.png[Picture of challenge location]

The goal of this challenge is to find a way to escape from https://www.gnu.org/software/ed/manual/ed_manual.html[ed].

.Initial
----
                  ........................................
               .;oooooooooooool;,,,,,,,,:loooooooooooooll:
             .:oooooooooooooc;,,,,,,,,:ooooooooooooollooo:
           .';;;;;;;;;;;;;;,''''''''';;;;;;;;;;;;;,;ooooo:
         .''''''''''''''''''''''''''''''''''''''''';ooooo:
       ;oooooooooooool;''''''',:loooooooooooolc;',,;ooooo:
    .:oooooooooooooc;',,,,,,,:ooooooooooooolccoc,,,;ooooo:
  .cooooooooooooo:,''''''',:ooooooooooooolcloooc,,,;ooooo,
  coooooooooooooo,,,,,,,,,;ooooooooooooooloooooc,,,;ooo,
  coooooooooooooo,,,,,,,,,;ooooooooooooooloooooc,,,;l'
  coooooooooooooo,,,,,,,,,;ooooooooooooooloooooc,,..
  coooooooooooooo,,,,,,,,,;ooooooooooooooloooooc.
  coooooooooooooo,,,,,,,,,;ooooooooooooooloooo:.
  coooooooooooooo,,,,,,,,,;ooooooooooooooloo;
  :llllllllllllll,'''''''';llllllllllllllc,



Oh, many UNIX tools grow old, but this one's showing gray.
That Pepper LOLs and rolls her eyes, sends mocking looks my way.
I need to exit, run - get out! - and celebrate the yule.
Your challenge is to help this elf escape this blasted tool.

-Bushy Evergreen

Exit ed.

1100
----

==== Solution

. Press `Q` then the `[enter]` key
+
image::side/00-escape-ed/01-solution.png[Picture of the solution dialog]

==== Chat

----
(Bushy Evergreen - PRE)
- Hi, I'm Bushy Evergreen. Welcome to Elf U!
- I'm glad you're here. I'm the target of a terrible trick.
- Pepper Minstix is at it again, sticking me in a text editor.
- Pepper is forcing me to learn ed.
- Even the hint is ugly. Why can't I just use Gedit?
- Please help me just quit the grinchy thing.

(Bushy Evergreen - POST)
-Wow, that was much easier than I'd thought.
-Maybe I don't need a clunky GUI after all!
-Have you taken a look at the password spray attack artifacts?
-I'll bet that DeepBlueCLI tool is helpful.
-You can check it out on GitHub.
-It was written by that Eric Conrad.
-He lives in Maine - not too far from here!
----
