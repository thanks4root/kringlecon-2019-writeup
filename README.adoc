= 2019 Kringlecon ctf writeup
Brandon Ingalls <brandon@tr4.dev>
v0.1.0, 2019-12-28
:toc:
:imagesdir: ./images

== Challenges

=== __ - Start of Kringlecon

Location: `Train Station`

Difficulty: `0/5`

image::99/00-Hello.png[My character next to santa]

* After signing in for the first time you find yourself at the `Train Station`
* Talk to `Santa`
* Get story
+
----
(Santa)
- Welcome to the North Pole and KringleCon 2!
- Last year, KringleCon hosted over 17,500 attendees and my castle got a little crowded.
- We moved the event to Elf University (Elf U for short), the North Pole’s largest venue.
- Please feel free to explore, watch talks, and enjoy the con!
----

=== 00 - Talk to Santa in the Quad

Location: `The Quad`

Difficulty: `0/5`

image::main/00/00-location.png[Me next to Santa]

.Objective
----
Enter the campus quad and talk to Santa.
----

==== Solution

. Click on `Santa` until they repeat

==== Chat

.Chat log
----
(Santa)
- This is a little embarrassing, but I need your help.
- Our KringleCon turtle dove mascots are missing!
- They probably just wandered off.
- Can you please help find them?
- To help you search for them and get acquainted with KringleCon, I’ve created some objectives for you. You can see them in your badge.
- Where's your badge? Oh! It's that big, circle emblem on your chest - give it a tap!
- We made them in two flavors - one for our new guests, and one for those who've attended both KringleCons.
- After you find the Turtle Doves and complete objectives 2-5, please come back and let me know.
- Not sure where to start? Try hopping around campus and talking to some elves.
- If you help my elves with some quicker problems, they'll probably remember clues for the objectives.
----

=== 01 - Find the Turtle Doves

Location: `Student Union`

Difficulty: `0/5`

image::main/01/00-location.png[Me next to the doves]

.Objective
----
Find the missing turtle doves.
----

==== Solution

. Click on the doves until they repeat

==== Chat

.Chat log
----
(Michael and Jane - Two Turtle Doves)
- Hoot Hooot?
----

=== 02 - Unredact Threatening Document

Location: `The Quad`

Difficulty: `1/5`

image::main/02/00-location.png[Me next to the redacted document]

.Objective
----
Someone sent a threatening letter to Elf University. What is the first word in ALL CAPS in the subject line of the letter? Please find the letter in the Quad.
----

==== Links

. https://mega.nz/#!N9gBVaSZ!FtcN0Sf22Nf7ma0OSWI0OOzs6xoH0UAE5CAcelpNQuU[LetterToElfUPersonnel.pdf]
** The redacted document
+
NOTE: SHA256 `2f7b3ba81f1718d29ee73e82b19eb0f7a85e5b7835aaac0155edd233619b3c5e`

==== Solution

. Open the PDF
+
image::main/02/01-document.png[Picture of redacted document]
+
. Select all text in the document
+
NOTE: Using `[Ctrl]` + `a`
+
image::main/02/02-selected.png[Picture of highlighted document]
+
. Copy the text
+
NOTE: Using `[Ctrl]` + `c`
+
. Paste the copied content into a text editor
+
NOTE: Using `[Ctrl]` + `v`
+
.Documents unredacted contents
----
Date: February 28, 2019

To the Administration, Faculty, and Staff of Elf University
17 Christmas Tree Lane
North Pole

From: A Concerned and Aggrieved Character

Subject: DEMAND: Spread Holiday Cheer to Other Holidays and Mythical Characters… OR
ELSE!


Attention All Elf University Personnel,

It remains a constant source of frustration that Elf University and the entire operation at the
North Pole focuses exclusively on Mr. S. Claus and his year-end holiday spree. We URGE
you to consider lending your considerable resources and expertise in providing merriment,
cheer, toys, candy, and much more to other holidays year-round, as well as to other mythical
characters.

For centuries, we have expressed our frustration at your lack of willingness to spread your
cheer beyond the inaptly-called “Holiday Season.” There are many other perfectly fine
holidays and mythical characters that need your direct support year-round.

If you do not accede to our demands, we will be forced to take matters into our own hands.
We do not make this threat lightly. You have less than six months to act demonstrably.

Sincerely,

--A Concerned and Aggrieved Character

Confidential
Confidential
----

NOTE: *Answer:* `DEMAND`

=== 03 - Windows Log Analysis: Evaluate Attack Outcome

Location: `Offline`

Difficulty: `1/5`

.Objective
----
We're seeing attacks against the Elf U domain! Using the event log data, identify the user account that the attacker compromised using a password spray attack. Bushy Evergreen is hanging out in the train station and may be able to help you out.
----

==== Links

. https://mega.nz/#!choxHC7K!C1r5Yp4ikeA_OnYswhEKuwLEqWgYxoLCAUTh-oMiiso[Security.evtx.zip]
** Archive containing a Windows event log export for `Security`
+
NOTE: SHA256 `7583da028561af31a25a9cecab2c0bb77967a646e4808773b0cc23e62b70c0dd`

==== Solution

. Setup working directory for this challenge
+
[source, bash, options="nowrap"]
----
# Create a temp directory
[~]$ cd "$(mktemp -d /tmp/ctf-03.XXX)"

# Extract the provided archive
[/tmp/ctf-03.rhb]$ unzip /path/to/Security.evtx.zip
Archive:  /path/to/Security.evtx.zip
  inflating: Security.evtx

# Create a python2 virtualenv
[/tmp/ctf-03.rhb]$ python2 -m virtualenv .venv

# Verify layout
[/tmp/ctf-03.rhb]$ ls -A1
Security.evtx
.venv
----
+
. Activate the python virtualenv
+
[source, bash, options="nowrap"]
----
[/tmp/ctf-03.rhb]$ source .venv/bin/activate
(.venv) [/tmp/ctf-03.rhb]$
----
+
. Install python tools
+
----
# Install tools via pip
(.venv) [/tmp/ctf-03.rhb]$ pip install \
                                       'python-evtx>=0.6.1' \
                                       'yq>=2.10.0'
----
+
. Convert `.evtx` to `.xml`
+
[source, bash, options="nowrap"]
----
# Convert evtx => xml
(.venv) [/tmp/ctf-03.rhb]$ time evtx_dump.py Security.evtx > Security.xml
evtx_dump.py Security.evtx > Security.xml  39.01s user 0.07s system 99% cpu 39.084 total

# Check sizes
(.venv) [/tmp/ctf-03.rhb]$ ls -Alh Security.evtx Security.xml
-rwxr-xr-x 1 t4r t4r 3.1M Nov 19 06:29 Security.evtx
-rw-r--r-- 1 t4r t4r 6.9M Dec 28 14:40 Security.xml
----
+
. Convert `.xml` to `.json`
+
[source, bash, options="nowrap"]
----
(.venv) [/tmp/ctf-03.rhb]$ time xq '.Events' Security.xml > Security.json
xq '.Events' Security.xml > Security.json  10.74s user 2.95s system 121% cpu 11.282 total
----
+
. Disable virtualenv
+
NOTE: We shouldn't need it anymore
+
[source, bash, options="nowrap"]
----
(.venv) [/tmp/ctf-03.rhb]$ deactivate
[/tmp/ctf-03.rhb]$
----
+
. Start pivoting with `jq`
.. Figure out when the attack started - Event ID 4625
+
[source, bash, options="nowrap"]
----
# Filter for failed logins
[/tmp/ctf-03.rhb]$ cat Security.json \
                     | jq '.Event[] | select(.System.EventID."#text"=="4625")' > Security-4625.json

# Store jq filter
[/tmp/ctf-03.rhb]$ read -r -d '' filter << 'EOF'
[
  {
    "time": .System.TimeCreated."@SystemTime",
    "user": .EventData.Data[] | select(."@Name"=="TargetUserName")."#text",
    "ip": .EventData.Data[] | select(."@Name"=="IpAddress")."#text"
  }
]
  | sort_by(.time)
    | .[]
EOF

# Parse into readable format
[/tmp/ctf-03.rhb]$ cat Security-4625.json \
                     | jq -c "${filter}" > failed_logins.jsonl
----
+
... Review `failed_logins.jsonl`
+
NOTE: Scan happened `2019-11-19 12:21` => `2019-11-19 12:22`
+
.. Event ID 4624 (An account was successfully logged on)
+
[source, bash, options="nowrap"]
----
# Filter for successful logins
[/tmp/ctf-03.rhb]$ cat Security.json \
                     | jq '.Event[] | select(.System.EventID."#text"=="4624")' > Security-4624.json
----
+
.Example 4624 event
image::main/03/00-4624.png[Example 4624 event]
+
.. Parse filtered `4624` events into a more readable format
+
[source, bash, options="nowrap"]
----
[/tmp/ctf-03.rhb]$ read -r -d '' filter << 'EOF'
[
  {
    "time": .System.TimeCreated."@SystemTime",
    "user": .EventData.Data[] | select(."@Name"=="TargetUserName")."#text",
    "ip": .EventData.Data[] | select(."@Name"=="IpAddress")."#text"
  }
]
  | sort_by(.time)
    | .[]
EOF

[/tmp/ctf-03.rhb]$ cat Security-4624.json \
                     | jq -c "${filter}" \
                       | tee logins.jsonl
{"time":"2019-08-24 00:00:20.189180","user":"pminstix","ip":"192.168.86.128"}
{"time":"2019-08-24 00:00:41.380116","user":"DC1$","ip":"fe80::75f6:7c88:9877:ce71"}
{"time":"2019-11-19 12:21:34.496546","user":"pminstix","ip":"192.168.86.128"}
{"time":"2019-11-19 12:21:41.375494","user":"DC1$","ip":"::1"}
{"time":"2019-11-19 12:21:45.755442","user":"supatree","ip":"127.0.0.1"}
{"time":"2019-11-19 12:21:46.715054","user":"DC1$","ip":"fe80::75f6:7c88:9877:ce71"}
{"time":"2019-11-19 12:21:46.724463","user":"DC1$","ip":"fe80::75f6:7c88:9877:ce71"}
{"time":"2019-11-19 12:22:25.172413","user":"DC1$","ip":"fe80::75f6:7c88:9877:ce71"}
{"time":"2019-11-19 12:22:25.175280","user":"DC1$","ip":"fe80::75f6:7c88:9877:ce71"}
{"time":"2019-11-19 12:22:25.180609","user":"DC1$","ip":"::1"}
{"time":"2019-11-19 12:22:25.184385","user":"DC1$","ip":"192.168.86.190"}
{"time":"2019-11-19 12:22:25.284060","user":"DC1$","ip":"fe80::75f6:7c88:9877:ce71"}
{"time":"2019-11-19 12:22:41.383135","user":"DC1$","ip":"::1"}
{"time":"2019-11-19 12:23:05.847099","user":"supatree","ip":"192.168.86.128"}
{"time":"2019-11-19 12:23:41.405107","user":"DC1$","ip":"::1"}
{"time":"2019-11-19 12:23:47.222954","user":"DC1$","ip":"fe80::75f6:7c88:9877:ce71"}
----
+
.. Filter out `Kerberos` events
+
[source, bash, options="nowrap"]
----
[/tmp/ctf-03.rhb]$ cat logins.jsonl | grep -vE 'DC1\$'
{"time":"2019-08-24 00:00:20.189180","user":"pminstix","ip":"192.168.86.128"}
{"time":"2019-11-19 12:21:34.496546","user":"pminstix","ip":"192.168.86.128"}
{"time":"2019-11-19 12:21:45.755442","user":"supatree","ip":"127.0.0.1"}
{"time":"2019-11-19 12:23:05.847099","user":"supatree","ip":"192.168.86.128"}
----
... Note the odd one out
+
----
{"time":"2019-11-19 12:21:45.755442","user":"supatree","ip":"127.0.0.1"}
----

NOTE: *Answer:* `supatree`

=== 04 - Windows Log Analysis: Determine Attacker Technique

Location: `Offline`

Difficulty: `2/5`

.Objective
----
Using these normalized Sysmon logs, identify the tool the attacker used to retrieve domain password hashes from the lsass.exe process. For hints on achieving this objective, please visit Hermey Hall and talk with SugarPlum Mary.
----

==== Links

* https://mega.nz/#!VwojHSaS!u7mcytO5T4rfpxLhMowJ3-fY4ROsDB4Tst-J6XbYoys[sysmon-data.json.zip]
** Archive containing Sysmon data formatted as json
+
NOTE: SHA256 `b54e4d573c100eb51328673f057e51b6292e2e071b421e94edf7d1fd02447d06`

==== Solution

. Create working directory
+
[source, bash, options="nowrap"]
----
# Create a temp directory
[~]$ cd "$(mktemp -d /tmp/ctf-04.XXX)"

# Unzip provided archive
[/tmp/ctf-04.9SY]$ unzip /path/to/sysmon-data.json.zip
Archive:  /path/to/sysmon-data.json.zip
  inflating: sysmon-data.json

# Verify size
[/tmp/ctf-04.9SY]$ ls -Alh sysmon-data.json
-rwx------ 1 t4r t4r 1.8M Dec  5 14:41 sysmon-data.json
----
+
. Figure out what type sysmon events we have
+
[source, bash, options="nowrap"]
----
[/tmp/ctf-04.9SY]$ cat sysmon-data.json | jq '[.[].event_type] | unique'
[
  "file",
  "network",
  "process",
  "registry"
]
----
+
NOTE: As the challenge is asking for what tool was run on the host I decided to start with `process` events (event_id: `1`)
+
. Filter out `event_type=process`
+
[source, bash, options="nowrap"]
----
# Filter process events into `sysmon-data-process.jsonl`
[/tmp/ctf-04.9SY]$ cat sysmon-data.json \
                     | jq -c '.[] | select(.event_type=="process")' > sysmon-data-process.jsonl

# Create an abbriged version of the process file
# - This is easier to skim through
[/tmp/ctf-04.9SY]$ cat sysmon-data-process.jsonl \
                     | jq -c '[{"timestamp", "user_name", "process_name", "command_line"}] | sort_by(.timestamp) | .[]' > process_short.jsonl

# Filter out boring commands with grep as you go
[/tmp/ctf-04.9SY]$ cat process_short.jsonl \
                     | grep -vE '(powershell|net|wevtutil|cmd)\.exe'
{"timestamp":132186398470300000,"user_name":"SYSTEM","process_name":"ntdsutil.exe","command_line":"ntdsutil.exe  \"ac i ntds\" ifm \"create full c:\\hive\" q q"}
----

NOTE: *Answer:* `ntdsutil`

[quote, 'https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc753343(v%3Dws.11)[Microsoft]']
Ntdsutil.exe is a command-line tool that provides management facilities for Active Directory Domain Services (AD DS) and Active Directory Lightweight Directory Services (AD LDS). You can use the ntdsutil commands to perform database maintenance of AD DS, manage and control single master operations, and remove metadata left behind by domain controllers that were removed from the network without being properly uninstalled. This tool is intended for use by experienced administrators.

=== 05 - Network Log Analysis: Determine Compromised System

Location: `Offline`

Difficulty: `2/5`

.Objective
----
The attacks don't stop! Can you help identify the IP address of the malware-infected system using these Zeek logs? For hints on achieving this objective, please visit the Laboratory and talk with Sparkle Redberry.
----

==== Links

* https://mega.nz/#!x0gVCSob!e6YHqJcdXYKVzdJDZOte2hpGZGN5uapE2UpBmFSGUQk[elfu-zeeklogs.zip]
** Archive of Zeek logs
+
NOTE: SHA256: `8b2d0d64c310d63efe9fc57e6945f9f8d4498501b39039cd161ee5a9485258af`

==== Solution

. Create working directory
+
[source, bash, options="nowrap"]
----
# Create a temp directory
[~]$ cd "$(mktemp -d /tmp/ctf-05.XXX)"

# Unzip provided archive
[/tmp/ctf-05.bl9]$ unzip /path/to/elfu-zeeklogs.zip
Archive:  /path/to/elfu-zeeklogs.zip
...
  inflating: elfu-zeeklogs/conn.log-00057_20190824000518.log
----
+
. Create tool to parse the `Zeek` logs into `jsonl`
+
NOTE: I made a quick python script to do this
+
NOTE: This will make it easier to use `jq` to filter the data
+
.Custom script
[source, bash, options="nowrap"]
----
# Extract log converter
[/tmp/ctf-05.bl9]$ base64 -d << 'EOF' | gzip --decompress > convert-log.py
H4sICHP2B14CA2NvbnZlcnQtbG9nLnB5AH1VPVPjMBDt/SuEUsSeAQNXZibFFRTXcBRU58t4RLxJ
dNiSR5JDgOG/366k+CMBXGRs6e3b75fZBbvurLl+kuoa1J61r26n1Y8kkU2rjWPCbFthLBy//1mt
ju/aJklSwYZ5RIlQm2aLhOHjTwxb9vb5T7PtGlDuwd+k2QiWi6oia3+f8lpv+SXbQd0u+YNwO+Y0
+wPwzOgi2JGr0ogXdBApxiF4iAHXGcX2eJ4e4dkkXqQrN7KGFF9i2A04gZzvH/7LAgKF05THvVbg
DzcS6sqOTyrhROleWzge+tNaKoghIn9uQFR0FKOjV7qJoNw6I9t4N2P3vx/vFuxxB+jNWBfQdqe7
umI7sQfm8Gov6g5YZ6FiwjIxRBtJwrPB6AltAHn0xr9jPB4jN4zPejPOlHZMKu8tlMPXUUgL7O6w
htZJrdL+gh4+fyf0x5y9YAxkT/xD3UKMvxgcWlg7qC54jgE1wqVktqSfrCfMpkUvbVtLF4uU+4+U
M36KArsWLdZgeWpZXN2uztp4ZpdXsNYVpLxTkl6uwnl0Q/NQ8KFEq88oQr+p0H3PqYp6OxTxq3b3
gBnze+HLR05ppph40p2bdCx2jXiKGwxmiQ3ki0lLPqvaX8dHvoI/A42OkzSfzVlrYCMPEwzFUT7D
a5ziUNSb1acYvB/Di9vFKjkDFkfIqqcj3Bi21spJ1UEyTpfmKqzdNNV+FYk33wJmGo5QPopVdkrR
7+mUZby+A1GLwhNoKOXkm+r28zA49N1DGTmg7YIdituVH48DzcUbNj5EeRnYso+JXcHfUOt8QH7c
+vCGIFojUSdJifOqa1qbEiYby17UuUZI5cUvyhspHiUWdNmGTAdVjXXSNidQLu1RHb1R9rUmoAwQ
AmWg0hB0AA7SumHd6XrZM8VhfJEYim5B9T4uGTdPPCNBm+zPuWAT2UnGGH5ZKtFAWfrNKEvKvyzj
glDGx/+L8R9FX6Slr1TyH0d4njISBwAA
EOF
----
+
. Start pivoting with Zeek conn events
+
[source, bash, options="nowrap"]
----
# Create `zeek.jsonl`
[/tmp/ctf-05.bl9]$ find ./elfu-zeeklogs/ \
                          -iname 'conn*.log' \
                          -type f \
                          -exec python ./convert-log.py {} ';' > zeek-conn.jsonl

# Check sizes
[/tmp/ctf-05.bl9]$ ls -lh zeek-conn.jsonl
-rw-r--r-- 1 t4r t4r 770M Dec 28 18:57 zeek-conn.jsonl

# Look for long-lived connections
[/tmp/ctf-05.bl9]$ cat zeek-conn.jsonl \
                     | jq -s -c '[.[] | select(.duration!="-")] | . | sort_by(.duration|tonumber) | reverse | .[]' \
                       | head \
                         | tee top-conn.txt

# Make it eaiser to read
[/tmp/ctf-05.bl9]$ cat top-conn.txt \
                     | jq -c '{"proto", "id.orig_h", "id.resp_h", "id.resp_p", "uid"}'
{"proto":"udp","id.orig_h":"10.142.148.1","id.resp_h":"255.255.255.255","id.resp_p":"17500","uid":"CFp61A2tCWNnVBMvZ8"}
{"proto":"udp","id.orig_h":"10.142.148.1","id.resp_h":"10.142.151.255","id.resp_p":"17500","uid":"CPEjh03sHL2fw2KVr9"}
{"proto":"tcp","id.orig_h":"192.168.134.130","id.resp_h":"148.69.64[.]76","id.resp_p":"443","uid":"C9mIoHHpnSvcvBUme"}
{"proto":"tcp","id.orig_h":"192.168.134.130","id.resp_h":"148.69.64[.]76","id.resp_p":"443","uid":"Cpsfbu2RiDZx0c8kn7"}
{"proto":"udp","id.orig_h":"10.142.148.1","id.resp_h":"255.255.255.255","id.resp_p":"17500","uid":"CHgaNmEHxh4EU0oQj"}
{"proto":"udp","id.orig_h":"10.142.148.1","id.resp_h":"10.142.151.255","id.resp_p":"17500","uid":"C0SkC82J7wY3N1WG5l"}
{"proto":"udp","id.orig_h":"10.142.148.1","id.resp_h":"255.255.255.255","id.resp_p":"17500","uid":"Cz6Yt11qPAC75MXHt4"}
{"proto":"udp","id.orig_h":"10.142.148.1","id.resp_h":"10.142.151.255","id.resp_p":"17500","uid":"CbtldJSgT161hzY53"}
{"proto":"tcp","id.orig_h":"192.168.134.130","id.resp_h":"148.69.64[.]76","id.resp_p":"443","uid":"C0ZpeF4800AaS7daZe"}
{"proto":"udp","id.orig_h":"10.142.148.1","id.resp_h":"255.255.255.255","id.resp_p":"17500","uid":"CW9Hxc1ETzjzpoCT8c"}
----
+
NOTE: `192.168.134.130` => `148.69.64[.]76:443/tcp` seems pretty *sketch*.

NOTE: *Answer:* `192.168.134.130`

==== Chat

.Chat log
----
(Santa)
- Thank you for finding Jane and Michael, our two turtle doves!
- I’ve got an uneasy feeling about how they disappeared.
- Turtle doves wouldn’t wander off like that.
- Someone must have stolen them! Please help us find the thief!
- It’s a moral imperative!
- I think you should look for an entrance to the steam tunnels and solve Challenge 6 and 7 too!
- Gosh, I can’t help but think:
- Winds in the East, snow coming in…
- Like something is brewing and about to begin!
- Can’t put my finger on what lies in store,
- But I fear what’s to happen all happened before!
----

=== 06 - Splunk

Location: `https://splunk.elfu.org/`

Difficulty: `3/5`

image::main/06/00-location.png[Challenge screen]

.Objective
----
Access https://splunk.elfu.org/ as elf with password elfsocks. What was the message for Kent that the adversary embedded in this attack? The SOC folks at that link will help you along! For hints on achieving this objective, please visit the Laboratory in Hermey Hall and talk with Prof. Banas.
----

==== Solution

===== Part A

We need to complete the Training questions to get important bits of information before we can complete the challenge question.

. What is the short host name of Professor Banas' computer?
** We can find this inside of the `SOC chat`
+
image::main/06/01-hostname.png[Picture showing hostname of sweetums]
+
NOTE: *Answer:* `sweetums`
+
. What is the name of the sensitive file that was likely accessed and copied by the attacker? Please provide the fully qualified location of the file. (Example: C:\temp\report.pdf)
** After solving question one, the chat app updates with more information
+
image::main/06/02-hint.png[Hint that gives you a starting search]
+
** The link takes you to the following Splunk search
+
----
index=main cbanas
----
+
** As the question was asking for information on information accessed by the attacker I used a basic search...
+
----
    index=main
AND cbanas
AND Users
----
+
image::main/06/03-answer.png[Answer for q02]
+
NOTE: *Answer:* `C:\Users\cbanas\Documents\Naughty_and_Nice_2019_draft.txt`
+
. What is the fully-qualified domain name(FQDN) of the command and control(C2) server? (Example: badguy.baddies[.]com)
** It looked like Empire was being used on the Windows host
** I did a search for Sysmon Event ID *3* made by `powershell.exe`
+
----
    index=main
AND EventID=3
AND Computer="sweetums*"
AND process_name="powershell.exe"
----
+
image::main/06/04-search.png[Search results]
+
NOTE: *Answer:* `144.202.46[.]214.vultr[.]com`
+
. What document is involved with launching the malicious PowerShell code? Please provide just the filename. (Example: results.txt)
** Did a basic search for Sysmon event id `1`
+
----
    index=main
AND EventID=1
AND Computer="sweetums*"
----
+
image::main/06/05-table.png[Search results]
+
** I see see Powershell running an Empire payload at `05:18 PM`
** https://gchq.github.io/CyberChef/#recipe=From_Base64('A-Za-z0-9%2B/%3D',true)Decode_text('UTF-16LE%20(1200)')Generic_Code_Beautify()[CyberChef Recipe]
+
image::main/06/06-payload.png[Empire payload decoded]
+
NOTE: The parent process of the malicious `powershell.exe` is `WmiPrvSE.exe`, so it was started via a script, going to guess it was from an office product macro.
+
** Struck out with this search
+
----
    index=main
AND EventCode=1
AND NOT docx
----
+
image::main/06/07-no-results.png[No bad results]
+
** Noticed this message in chat
+
image::main/06/08-chat.png[Chat message]
+
** Tried new search (Limited to around the time Empire payload was executed)
+
----
    index=main
AND EventCode=4688
AND NOT docx

| sort _time
----
+
image::main/06/09-found-bad.png[Table with bad doc]
+
NOTE: *Answer:* `19th Century Holiday Cheer Assignment.docm`
+
. How many unique email addresses were used to send Holiday Cheer essays to Professor Banas? Please provide the numeric value. (Example: 1)
** Read the chat
+
image::main/06/10-chat.png[Chat message]
+
** Need to look for emails with the subject of *Holiday Cheer Assignment Submission*
+
.Query
----
    index=main
AND sourcetype=stoq
AND results{}.workers.smtp.subject="Holiday Cheer Assignment Submission"

| eval email_from = mvindex(lower('results{}.workers.smtp.from'), 0)
  | stats dc(email_from)
----
+
NOTE: *Answer:* `21`
+
. What was the password for the zip archive that contained the suspicious file?
** Starting with this search
+
----
    index=main
AND sourcetype=stoq
AND results{}.workers.smtp.subject="Holiday Cheer Assignment Submission"
AND docm
----
+
image::main/06/11-results.png[Search results]
+
NOTE: *Answer:* `123456789`
+
. What email address did the suspicious file come from?
** Using my table from the previous question I was able to pull the email address for this question
+
NOTE: *Answer:* `bradly.buttercups@eifu[.]org`

==== Part B

NOTE: This is the official challenge solution, we needed the information from the training questions to get the data for this question.

. Find artifact meta information
+
image::main/06/12-artifacts.png[Email artifacts]
+
. Convert artifact links to download urls
+
NOTE: We are provided with a http://elfu-soc.s3-website-us-east-1.amazonaws.com/[link] to the SOCs case artifacts
+
[source, bash, options="nowrap"]
----
# Create work dir
[~]$ cd "$(mktemp -d /tmp/ctf-06.XXX)"

# Convert to bucket urls
[/tmp/ctf-06.I4z]$ sed -re 's,^,http://elfu-soc.s3-website-us-east-1.amazonaws.com/stoQ%20Artifacts,' << 'EOF' | tee urls.txt
/home/ubuntu/archive/7/f/6/3/a/7f63ace9873ce7326199e464adfdaad76a4c4e16
/home/ubuntu/archive/9/b/b/3/d/9bb3d1b233ee039315fd36527e0b565e7d4b778f
/home/ubuntu/archive/c/6/e/1/7/c6e175f5b8048c771b3a3fac5f3295d2032524af
/home/ubuntu/archive/b/e/7/b/9/be7b9b92a7acd38d39e86f56e89ef189f9d8ac2d
/home/ubuntu/archive/1/e/a/4/4/1ea44e753bd217e0edae781e8b5b5c39577c582f
/home/ubuntu/archive/e/e/b/4/0/eeb40799bae524d10d8df2d65e5174980c7a9a91
/home/ubuntu/archive/1/8/f/3/3/18f3376a0ce18b348c6d0a4ba9ec35cde2cab300
/home/ubuntu/archive/f/2/a/8/0/f2a801de2e254e15840460f4a53e568f6622c48b
/home/ubuntu/archive/1/0/7/4/0/1074061aa9d9649d294494bb0ae40217b9c7a2d9
/home/ubuntu/archive/8/6/c/4/d/86c4d8a2f37c6b4709273561700640a6566491b1
/home/ubuntu/archive/a/2/b/b/1/a2bb14afe8161ee9bd4a6ea10ef5a9281e42cd09
/home/ubuntu/archive/4/0/d/c/1/40dc1e00e2663cb33f8c296cdb0cd52fa07a87b6
/home/ubuntu/archive/f/5/c/b/a/f5cba8a650d6ada98d170f1b22098d93b8ff8879
/home/ubuntu/archive/0/2/b/6/7/02b67cad55d2684115a7de04d0458a3af46b12c6
/home/ubuntu/archive/1/7/6/1/2/1761214092f5c0e375ab3bc58a8687134b7f2582
/home/ubuntu/archive/b/7/7/0/f/b770f3a79423882bdae4240e995c0885770022ef
/home/ubuntu/archive/9/d/7/a/b/9d7abf0ee4effcecad80c8bbfb276079a05b4342
/home/ubuntu/archive/e/9/2/1/1/e9211c706be234c20d3c02123d85fea50ae638fd
/home/ubuntu/archive/f/f/1/e/a/ff1ea6f13be3faabd0da728f514deb7fe3577cc4
/home/ubuntu/archive/7/f/6/3/a/7f63ace9873ce7326199e464adfdaad76a4c4e16
/home/ubuntu/archive/9/b/b/3/d/9bb3d1b233ee039315fd36527e0b565e7d4b778f
/home/ubuntu/archive/c/6/e/1/7/c6e175f5b8048c771b3a3fac5f3295d2032524af
EOF
----
+
. Download artifacts
+
[source, bash, options="nowrap"]
----
# Create artifact directory
[/tmp/ctf-06.I4z]$ mkdir artifacts && cd artifacts

# Downlaod the artifacts
[/tmp/ctf-06.I4z/artifacts]$ for url in $(cat ../urls.txt); do curl -OL "${url}"; done
----
+
. Look for messages to Kent
+
NOTE: I've only showed the relevant content
+
[source, bash, options="nowrap"]
----
[/tmp/ctf-06.I4z/artifacts]$ grep -ir 'kent'
ff1ea6f13be3faabd0da728f514deb7fe3577cc4:...<dc:description>Kent you are so unfair. And we were going to make you the king of the Winter Carnival.</dc:description>...
----

image::main/06/13-end.png[Congrats screen]

*Answer*: `Kent you are so unfair. And we were going to make you the king of the Winter Carnival.`

=== 07 - Get Access To The Steam Tunnels

Location: `Dorm`

Difficulty: `3/5`

image::main/07/00-location.png[Room in the dorm]

.Objective
----
Gain access to the steam tunnels. Who took the turtle doves? Please tell us their first and last name. For hints on achieving this objective, please visit Minty's dorm room and talk with Minty Candy Cane.
----

==== Solution

[quote, Minty Candycane]
Maybe you'll see someone hopping around with a key here on campus.

The goal of this challenge is to decode a key's bitting via an image of the key.

When you first enter the room there is a NPC character that leaves into another room after a few moments.

NOTE: This character has the key you are looking for on their belt.

. Open the browser's network tools tab
+
image::main/07/01-tools.png[Network tool]
+
. Enter the room
. Locate the NPC's asset load network event
+
image::main/07/02-get.png[Krampus asset network event]
+
. Save the asset
+
----
https://2019.kringlecon.com/images/avatars/elves/krampus.png
----
+
image::main/07/03-krampus.png[Krampus asset, height=100, width=100]
+
. Cleaned the picture up with GIMP
+
image::main/07/04-key.png[Plain key]
+
. Decoded the key by looking at the heights relative to each other
+
NOTE: *Key Bitting*: `122520`
+
image::main/07/07-make-key.png[Crerating a key]
+
image::main/07/05-122520.png[My key]

image::main/07/06-win.png[Win screen]

==== Chat

.Chat log
----
(Minty Candycane; Had to complete Holiday Hack Trail)
- You made it - congrats!
- Have you played with the key grinder in my room? Check it out!
- It turns out: if you have a good image of a key, you can physically copy it.
- Maybe you'll see someone hopping around with a key here on campus.
- Sometimes you can find it in the Network tab of the browser console.
- Deviant has a great talk on it at this year's Con.
- He even has a collection of key bitting templates for common vendors like Kwikset, Schlage, and Yale.

(Krampus - POST)
- Hello there! I’m Krampus Hollyfeld.
- I maintain the steam tunnels underneath Elf U,
- Keeping all the elves warm and jolly.
- Though I spend my time in the tunnels and smoke,
- In this whole wide world, there's no happier bloke!
- Yes, I borrowed Santa’s turtle doves for just a bit.
- Someone left some scraps of paper near that fireplace, which is a big fire hazard.
- I sent the turtle doves to fetch the paper scraps.
- But, before I can tell you more, I need to know that I can trust you.
- Tell you what – if you can help me beat the Frido Sleigh contest (Objective 8), then I'll know I can trust you.
- The contest is here on my screen and at fridosleigh.com.
- No purchase necessary, enter as often as you want, so I am!
- They set up the rules, and lately, I have come to realize that I have certain materialistic, cookie needs.
- Unfortunately, it's restricted to elves only, and I can't bypass the CAPTEHA.
- (That's Completely Automated Public Turing test to tell Elves and Humans Apart.)
- I've already cataloged 12,000 images and decoded the API interface.
- Can you help me bypass the CAPTEHA and submit lots of entries?
----

== Side challenges

=== Escaping ED

Location: `Train Station`

image::side/00-escape-ed/00-location.png[Picture of challenge location]

The goal of this challenge is to find a way to escape from https://www.gnu.org/software/ed/manual/ed_manual.html[ed].

.Initial
----
                  ........................................
               .;oooooooooooool;,,,,,,,,:loooooooooooooll:
             .:oooooooooooooc;,,,,,,,,:ooooooooooooollooo:
           .';;;;;;;;;;;;;;,''''''''';;;;;;;;;;;;;,;ooooo:
         .''''''''''''''''''''''''''''''''''''''''';ooooo:
       ;oooooooooooool;''''''',:loooooooooooolc;',,;ooooo:
    .:oooooooooooooc;',,,,,,,:ooooooooooooolccoc,,,;ooooo:
  .cooooooooooooo:,''''''',:ooooooooooooolcloooc,,,;ooooo,
  coooooooooooooo,,,,,,,,,;ooooooooooooooloooooc,,,;ooo,
  coooooooooooooo,,,,,,,,,;ooooooooooooooloooooc,,,;l'
  coooooooooooooo,,,,,,,,,;ooooooooooooooloooooc,,..
  coooooooooooooo,,,,,,,,,;ooooooooooooooloooooc.
  coooooooooooooo,,,,,,,,,;ooooooooooooooloooo:.
  coooooooooooooo,,,,,,,,,;ooooooooooooooloo;
  :llllllllllllll,'''''''';llllllllllllllc,



Oh, many UNIX tools grow old, but this one's showing gray.
That Pepper LOLs and rolls her eyes, sends mocking looks my way.
I need to exit, run - get out! - and celebrate the yule.
Your challenge is to help this elf escape this blasted tool.

-Bushy Evergreen

Exit ed.

1100
----

==== Solution

. Press `Q` then the `[enter]` key
+
image::side/00-escape-ed/01-solution.png[Picture of the solution dialog]

==== Chat

.Chat log
----
(Bushy Evergreen - PRE)
- Hi, I'm Bushy Evergreen. Welcome to Elf U!
- I'm glad you're here. I'm the target of a terrible trick.
- Pepper Minstix is at it again, sticking me in a text editor.
- Pepper is forcing me to learn ed.
- Even the hint is ugly. Why can't I just use Gedit?
- Please help me just quit the grinchy thing.

(Bushy Evergreen - POST)
-Wow, that was much easier than I'd thought.
-Maybe I don't need a clunky GUI after all!
-Have you taken a look at the password spray attack artifacts?
-I'll bet that DeepBlueCLI tool is helpful.
-You can check it out on GitHub.
-It was written by that Eric Conrad.
-He lives in Maine - not too far from here!
----

=== Frosty Keypad

Location: `The Quad`

image::side/01-frosty-keypad/00-location.png[Picture of challenge location]

The goal of this challenge is to guess the pin for a keypad, this gives you access to the dorms which is required for main challenge 06.

image::side/01-frosty-keypad/01-keypad.png[Image of the keypad]

==== Solution

. Noted that the three worn digits were `1, 3, 7`
. Looked at what `Tangle Coalbox` told me
.. One digit is repeated once
.. Code is a prime number
. The available numbers made me think of *leet* speak
. Remembered that `1337` is not prime -- but `7331` is

NOTE: *Answer*: `7331`

==== Chat

.Chat log
----
(Tangle Coalbox - PRE)
- Hey kid, it's me, Tangle Coalbox.
- I'm sleuthing again, and I could use your help.
- Ya see, this here number lock's been popped by someone.
- I think I know who, but it'd sure be great if you could open this up for me.
- I've got a few clues for you.
-- One digit is repeated once.
-- The code is a prime number.
-- You can probably tell by looking at the keypad which buttons are used.

(Tangle Coalbox - POST)
- Yep, that's it. Thanks for the assist, gumshoe.
- Hey, if you think you can help with another problem, Prof. Banas could use a hand too.
- Head west to the other side of the quad into Hermey Hall and find him in the Laboratory.
----

=== Holiday Hack Trail

Location: `Dorm`

image::side/02-holiday-hack-trail/00-location.png[Picture of challenge location]

The goal of this challenge is to cheat at a game that has very basic anti-cheat built in.

image::side/02-holiday-hack-trail/01-screen.png[Image of the keypad]

==== Solution

===== Easy

. Start a game
. Played with the url
+
----
hhc://trail.hhc/store/?difficulty=0&distance=0&money=5000&pace=0&curmonth=7&curday=1&reindeer=2&runners=2&ammo=100&meds=20&food=400&name0=Ryan&health0=100&cond0=0&causeofdeath0=&deathday0=0&deathmonth0=0&name1=Anna&health1=100&cond1=0&causeofdeath1=&deathday1=0&deathmonth1=0&name2=Chris&health2=100&cond2=0&causeofdeath2=&deathday2=0&deathmonth2=0&name3=Mathias&health3=100&cond3=0&causeofdeath3=&deathday3=0&deathmonth3=0
----
+
. Noticed that `distance` could be changed
. Set `distance` => `7990`
+
----
hhc://trail.hhc/store/?difficulty=0&distance=7990&money=5000&pace=0&curmonth=7&curday=1&reindeer=2&runners=2&ammo=100&meds=20&food=400&name0=Ryan&health0=100&cond0=0&causeofdeath0=&deathday0=0&deathmonth0=0&name1=Anna&health1=100&cond1=0&causeofdeath1=&deathday1=0&deathmont
----
+
image::side/02-holiday-hack-trail/02-edited.png[Edited url]
+
. Click *Buy* button in store
+
image::side/02-holiday-hack-trail/03-close.png[Close to the end]
+
. Press *Go*

image::side/02-holiday-hack-trail/04-win.png[Win message]

==== Chat

.Chat log
----
(Minty Candycane - PRE)
- Hi! I'm Minty Candycane!
- I just LOVE this old game!
- I found it on a 5 1/4" floppy in the attic.
- You should give it a go!
- If you get stuck at all, check out this year's talks.
- If you get stuck at all, check out this year's talks.
- One is about web application penetration testing.
- Good luck, and don't get dysentery!


(Minty Candycane - POST)
- You made it - congrats!
- Have you played with the key grinder in my room? Check it out!
- It turns out: if you have a good image of a key, you can physically copy it.
- Maybe you'll see someone hopping around with a key here on campus.
- Sometimes you can find it in the Network tab of the browser console.
- Deviant has a great talk on it at this year's Con.
- He even has a collection of key bitting templates for common vendors like Kwikset, Schlage, and Yale.
----
